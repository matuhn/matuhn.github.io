---
layout: post
comments: true
title: FUCTF Season 1
categories: ['2019']
---
Lần đầu viết writeup dưới vị trí của tác giả, mong mọi ý kiến đóng góp từ mọi người
Source code các challenge:
[https://github.com/matuhn/MyCTFChallenge](https://github.com/matuhn/MyCTFChallenge)

**1/Baby Warmup**

Bài này là bài mình viết dành riêng cho các bạn vừa tiếp cận với mảng web, vì giải 
này mục đích là thúc đẩy phong trào CTF của trường mình mà nhưng không hiểu sao có
khá nhiều team đến gần cuối giờ mới solved bài này, kể cả team Top 1, Top 2 đã clear
hết các bài khó :/

Walk through qua source code của bài này 

```
<?php 

	if (!isset($_SESSION['level'])){
		$_SESSION['level'] = 'level1';
	}

	if ($_SESSION['level'] == 'level1'){
		if ($_SERVER['REQUEST_METHOD'] === 'POST'){
			$_SESSION['level'] = 'level2';
		}
		else if ($_SERVER['REQUEST_METHOD'] !== 'POST'){
			echo '<h1>Try again with POST request</h1>';
		}
	}

	if ($_SESSION['level'] == 'level2'){
		if ($_SERVER['HTTP_USER_AGENT']==='FUCTF Browser'){
			$_SESSION['level'] = 'level3';
		}
		else if (!strpos($_SERVER['HTTP_USER_AGENT'],'FUCTF Browser')){
			echo '<h1>You need to use our browser (FUCTF Browser) to pass this step, agent! </h1>';
		}
	
	}

	if ($_SESSION['level'] == 'level3'){
		if ($_SERVER['HTTP_REFERER'] == '127.0.0.1'){
			$_SESSION['level'] = 'level4';
		}
		else if ($_SERVER['HTTP_REFERER'] != '127.0.0.1'){
			echo '<h1>This place don\'t accept external connection, please try again from 127.0.0.1!</h1>';
		}
	
	}

	if ($_SESSION['level'] == 'level4'){
		if (!isset($_COOKIE['privilege'])){
			setcookie('privilege','guest');
		}
		if ($_COOKIE['privilege'] == 'admin' ){
			$flag = "ZnVjdGZ7dzNsY29tM190MF93M2JfdzBybGQhISF9";
			echo "GG! You know all the basic thing. Good luck in w3b w0rld\n";
			echo "Here is your flag champion!!!!\n";
			echo $flag;
		}
		else if ($_COOKIE['privilege'] !== 'admin'){
			echo "Only admin is allowed to see the secret of web world!!!";
			
		}
	
	}


?>
```

Những thứ các bạn cần làm là sửa http header request thành POST, User Agent = 'FUCTF Browser'
http header Referer có giá trị là 127.0.0.1, và giá trị cookie Privilege là 'admin'

Để custom http header theo ý mình như thế này thì các bạn có thể dùng burp, hoặc curl

Flag: fuctf{w3lcom3_t0_w3b_w0rld!!!}

Btw có vài team đến đoạn cuối rồi submit cả cái base64 lên, mình hint là base64 thì lại
submit fuctf{base64}... Tiếc cho 50 điểm


**2/ Only Dr.Strange can do this**

Bài này mình code chóng vánh trước giờ thi 30p, nhưng lại là bài có first blood chậm nhất trong 
các bài, mà cũng không biết bằng cách thần thánh nào đó, 1 đội đã tìm thấy writeup 1 bài tương tự
nếu không muốn nói là giống y chang bài này, và đã xuất hiện cách đây 2 năm... Bài này ý tưởng từ
việc học về 4 scope request, session, page, và 1 cái gì đó mình quên rồi trong giờ học Java Web ở
trường, nhưng mà thôi bài này với bài kia không liên quan gì, chắc do ý tưởng gặp nhau

Source Code:

```
if (isset ($_GET['number'])) {
    if ($_GET['number'] == $_SESSION['number'])
        die ('Flag: '.$flag);
    else
        $result .='<p>Wrong guess.</p></br>'.$_SESSION['number'];
}
$_SESSION['number'] = (rand(1,999)^rand(1,999)+rand(1,999))/rand(1,999);
```

Ở đây thì dễ dàng nhận thấy SESSION['number'] được lấy ra trước khi set, có nghĩa là cuối request thứ 
nhất sẽ set random number cho request thứ 2, theo vậy thì mình dễ dàng control được cho nó bằng null 
bằng cách gửi đi header không có Cookie PHPSESSIONID và param = NULL, khi đó NULL == NULL -> win

Flag: fuctf{th1s_1s_gu3ss_ctf}

**3/ Old School**

Như description đã nói

```
I made a ping service for you guys. You can find this kind of system anywhere like root-me,... But 
this service has a difference to prevent hacker 
```

Bài này mình lấy idea từ root-me, và 1 report của Hackerone về việc RCE bằng cách dùng { để escape 
command và ',' thay cho space. Nắm được cách bypass rồi thì sẽ có thể chọn curl nội dung trang index về 
hoặc nslookup mỗi 63 char về dns server hoặc up shell, rất nhiều cách 

Flag: fuctf{s0m3_t1m3_c0mm4nd_1s_3x3cut3d_but_y0u_c4n't_s33!}


**4/ Bet Bủng*

Bài này khi mua vé số thì sẽ được gen ra 1 vé số có dạng base64 
Ví dụ: TzoxMToia2hvYWRlcHRyYWkiOjM6e3M6NzoiamFja3BvdCI7TjtzOjU6ImVudGVyIjtzOjI6IjExIjtzOjU6InZhbHVlIjtpOjEwMDA7fQ
Vứt bừa vào 1 cái tool base64decode thì được:
O:11:"khoadeptrai":3:{s:7:"jackpot";N;s:5:"enter";s:2:"11";s:5:"value";i:1000;}
Đây là dạng Object PHP Serialization, nếu bạn search google thì sẽ có rất nhiều writeup hướng dẫn cách
bypass, ở writeup này thì mình sử dụng con trỏ Reference để bypass 
O:11:"khoadeptrai":3:{s:7:"jackpot";N;s:5:"enter";R:2;s:5:"value";i:1000;}
trỏ đến variable thứ 2 (trừ cái Object) để cho giá trị bet luôn luôn bằng jackpot 
Đem base64 xong đập vào /bet.php thì bạn sẽ dễ dàng win, chả quan tâm nó quay ra số gì luôn, nhưng để win thì phải
mua được shiba. Shiba thì mình bán cả tỷ hay sao ấy (Mình thích Shiba mà :D) 

Tới đây sẽ có 2 luồng suy nghĩ:
1. Bạn sẽ tiếp tục ôm payload đó và brute banh xác để lên 1 tỷ 
2. Bạn sẽ tiếp tục sửa Object để được bet nhiều hơn 

Ở cách thứ nhất thì cũng ok nhưng bạn sẽ mất khoảng 10000000 request hay sao đó :))) 
Ở cách thứ hai thì điều đầu tiên bạn làm là sửa biến value đúng ko?. Nhưng bài này mình có gài thêm OTP, là 1 chức năng
bị khóa, nhưng đâu có lí do gì mà mình code cả cái khung nhập OTP rồi disable nó đi đúng không? :/ 

Cứ sửa bừa object thành:
O:11:"khoadeptrai":3:{s:7:"jackpot";N;s:5:"enter";s:2:"11";s:5:"value";i:99999999999;}
Đập vào, bùm, You need valid OTP to bet more...

Okay ngó qua trang market thì mình có bán Source, mua ngay thì được 2 file PHP 

bet.php

```
<?php include('header.php'); ?>

<?php
class khoadeptrai 
{ 
  var $jackpot;
  var $enter;
  var $value;
  var $otp; 
}
?>
</style>
<h2><center>Use ticket for betting!</center></h2>

<center><form method="POST">
<input type="text" name="ticket">
<button type="submit" name="btn-submit" value="Buy Ticket">Bet with 1000$!</button>
</form></center>
<?php
$result ="";
if (isset($_POST['ticket']) && isset($_SESSION['money']) && ($_SESSION['money']>=1000))
{
  	$obj = unserialize(base64_decode($_POST['ticket']));
  if($obj)
  {
    $obj->jackpot = rand(0,9).''.rand(0,9);
    if ((int)$obj->value == 1000)
      $valid = 1;
    else {
      if ($obj->otp == (rand(0,50).'ilovedoge'.rand(0,99999999).'nottrytoguessthis'))
        $valid = 1;
      else $valid = 0;
    }
    if ($valid == 1){
      if ($obj->enter === $obj->jackpot){
    	 $result .= 'Hey, hey, hey you win '.($obj->value);
    	 $_SESSION['money'] += (int)($obj->value);
      }
      else{
    	 $result .= 'You guess '.$obj->enter.', sorry it is '.$obj->jackpot;
    	 $_SESSION['money'] -= (int)($obj->value);
      }
    }
    else {
      $result .='You need a valid OTP to confirm when you want to bet all in what you have';
    }

  }
  else
  {
    $result .='How you think you can hack me? ';
  }
}
  elseif ($_SESSION['money']<1000) {
  	$result='You are out of money dude, I don\'t know why you need to waste your time for betting, I give you more 1000$ for betting and I will continue to read docs about deserialization and some kind of basic encrypting';
  	$_SESSION['money'] = 1000;
  }
?>

<section>
    <div class="container content">
                <div>
            <table class="table is-bordered is-narrow is-hoverable is-fullwidth">
                <tbody>
                                </tbody>
            </table>
                            <h3 class="is-st">Result:</h3>
                <ul class="fa-ul">
                    <li><i class="fa-li fa fa-check fa-green"></i>
                                <?php
                                        echo "<pre>$result</pre>";
                                ?>
                    </li>
                    
                </ul>
                        </div>
        
    </div>

</section>
<div class="copyrights has-text-centered">
            <center>Doge is the bezt , is it right?</center>
        </div>
```

buy.php

```
<?php include('header.php'); ?>

<?php
class khoadeptrai 
{ 
  var $jackpot;
  var $enter;
  var $value; 
}
?>

<h2><center>Buy a ticket!</center></h2>
<center><form method="POST">
<input type="text" name="ticket" id="numbers" minlength="2" maxlength="2" pattern="\d{2}" required placeholder="2 numbers">
<button type="submit" name="btn-submit" value="Buy Ticket">Buy Ticket For Nothing</button>
</form>
<form method="POST" action="#">
<h2>Bet more than $1000(Under Maintenance)</h2></br>
<input  type="text" name="value" placeholder="Value" disabled>
<input type="text" name="otp" placeholder="OTP code" disabled>
<button type="submit" name="btn-submit" value="Buy Ticket" disabled>Confirm!</button>
</form>
</center>

<?php

if (isset($_POST['ticket']) && !empty($_POST['ticket']))
{
  	$temp = new khoadeptrai;
  	$temp->enter=$_POST['ticket'];
  	$temp->value=1000;
  	$code=serialize($temp);
  	$code=base64_encode($code);
  	$result='Use this ticket\'s code for betting: <strong>'.$code.'</strong>';
}
?>
<section>
    <div class="container content">
                <div>
            <table class="table is-bordered is-narrow is-hoverable is-fullwidth">
                <tbody>
                                </tbody>
            </table>
                            <h3 class="is-st">Result:</h3>
                <ul class="fa-ul">
                    <li><i class="fa-li fa fa-check fa-green"></i>
                                <?php
                                        echo "<pre>$result</pre>";
                                ?>
                    </li>
                    
                </ul>
                        </div>
        
    </div>

</section>
<div class="copyrights has-text-centered">
            <center>Doge is the bezt , is it right?</center>
        </div>
```
Okay dễ dàng nhận thấy Object ở file bet.php thì có $otp nhưng buy.php thì không (Tất nhiên rồi vì mình đang
disable chức năng OTP mà :D)

Phần check OTP:

```
if ($obj->otp == (rand(0,50).'ilovedoge'.rand(0,99999999).'nottrytoguessthis'))
```
GuessCTF... Tất nhiên là không tìm cách đoán cho ra cái otp này rồi, PHP có 1 cái gọi là type juggling, như 
thế nào thì các bạn search Google nha. Chỗ này bypass bằng type juggling, brute đến khi có win 999999999, lấy
PHPSESSIONID ra  -> win

Flag: fuctf{s3r1al1z3_1s_1nt3r3st1ng_r1ght?}

**5/ dendakhongduong**

Ye và đây là challenge 100 điểm mà mãi mới có first blood, chắc do đề guessing quá mức =)))
Hint : I'm interested in this one
https://en.wikipedia.org/wiki/Sound
. . . . . . . . . . . . . . . and this one https://en.wikipedia.org/wiki/Raw_image_format

Như hint mình có ấn tượng với sound wave và cũng như là raw image. Nhưng ứng dụng cả 2 vào thì sao? Mình sẽ 
xem sound wave bằng raw file :)

Flag: fuctf{y0u_ar3_my_sug4r_sug4r}

**6/ voLeeSongnghiBeautiful**

Dẫn lại cái ảnh nào
![](https://i.imgur.com/maoxEOK.png)

Bài này khá nhiều người solve, do ra đề toang rồi

1 số Link tham khảo
https://www.computerhope.com/jargon/l/leastsb.htm

https://github.com/RobinDavid/LSB-Steganography

Flag: fuctf{LSB_1s_one_kind_of_St3g0}

![](https://i.imgur.com/BybeQkI.png)

**Bonus**

Ra đề xàm quá nên...:(

![](https://i.imgur.com/aqL6owV.png)



Cảm ơn các bạn vì đã tham gia FUCTF Season 1. Hẹn gặp lại!!!











